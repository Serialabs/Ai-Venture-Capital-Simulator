name: Deploy static site to GitHub Pages

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

permissions:
  actions: write
  contents: read
  pages: write
  id-token: write

concurrency:
  group: pages
  cancel-in-progress: true

jobs:
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Remove stale github-pages artifacts from this run
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const run_id = context.runId;
            const artifactName = 'github-pages';

            const artifacts = await github.paginate(
              github.rest.actions.listWorkflowRunArtifacts,
              {
                owner,
                repo,
                run_id,
                per_page: 100,
              }
            );

            const staleArtifacts = artifacts.filter(
              (artifact) => artifact.name === artifactName
            );

            core.info(
              `Found ${staleArtifacts.length} artifact(s) named ${artifactName} for run ${run_id}.`
            );

            for (const artifact of staleArtifacts) {
              core.info(`Deleting artifact ${artifact.id} (${artifact.name})...`);
              await github.rest.actions.deleteArtifact({
                owner,
                repo,
                artifact_id: artifact.id,
              });
            }

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: .

      - name: Debug Pages artifacts for current run
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const run_id = context.runId;

            const artifacts = await github.paginate(
              github.rest.actions.listWorkflowRunArtifacts,
              { owner, repo, run_id, per_page: 100 }
            );

            const countsByName = artifacts.reduce((acc, artifact) => {
              acc[artifact.name] = (acc[artifact.name] || 0) + 1;
              return acc;
            }, {});

            core.info(`Found ${artifacts.length} artifact(s) for run ${run_id}.`);
            for (const [name, count] of Object.entries(countsByName)) {
              core.info(`- ${name}: ${count}`);
            }

            const pagesArtifactCount = countsByName['github-pages'] || 0;
            if (pagesArtifactCount > 1) {
              core.warning(
                `Detected duplicate github-pages artifacts (${pagesArtifactCount}) in run ${run_id}. ` +
                'This can cause deployment to fail. Recommendation: trigger a new workflow run to generate a single fresh artifact.'
              );
            }

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
