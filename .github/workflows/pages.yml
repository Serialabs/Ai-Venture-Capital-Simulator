name: Deploy static site to GitHub Pages

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

permissions:
  actions: write
  contents: read
  pages: write
  id-token: write

concurrency:
  group: pages
  cancel-in-progress: true

jobs:
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Remove stale github-pages artifacts from this run
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const run_id = context.runId;
            const artifactName = 'github-pages';

            const artifacts = await github.paginate(
              github.rest.actions.listWorkflowRunArtifacts,
              {
                owner,
                repo,
                run_id,
                per_page: 100,
              }
            );

            const staleArtifacts = artifacts.filter(
              (artifact) => artifact.name === artifactName
            );

            core.info(
              `Found ${staleArtifacts.length} artifact(s) named ${artifactName} for run ${run_id}.`
            );

            for (const artifact of staleArtifacts) {
              core.info(`Deleting artifact ${artifact.id} (${artifact.name})...`);
              await github.rest.actions.deleteArtifact({
                owner,
                repo,
                artifact_id: artifact.id,
              });
            }

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: .

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
